{"ast":null,"code":"// save-agri-frontend/src/services/api.js\nimport axios from 'axios';\nimport authService from './authService';\n\n// Configuration de l'URL de base pour les requêtes API\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001';\n\n// Configuration de l'intercepteur axios pour ajouter le token d'authentification\naxios.interceptors.request.use(config => {\n  const token = sessionStorage.getItem('token');\n  if (token) {\n    config.headers['Authorization'] = `Bearer ${token}`;\n  }\n  return config;\n}, error => {\n  return Promise.reject(error);\n});\n\n// Intercepteur pour gérer les réponses\naxios.interceptors.response.use(response => {\n  // Réinitialiser le timer d'inactivité à chaque réponse réussie\n  if (authService.isAuthenticated()) {\n    authService.resetInactivityTimer();\n  }\n  return response;\n}, error => {\n  // Si l'erreur est 401 (non autorisé), déconnexion\n  if (error.response && error.response.status === 401) {\n    authService.logout();\n  }\n  return Promise.reject(error);\n});\n\n// Service pour les opérations liées aux utilisateurs\nconst userService = {\n  // Inscription\n  register: async userData => {\n    try {\n      const response = await axios.post(`${API_URL}/users`, userData); // Modification ici\n      if (response.data && response.data.token) {\n        const token = response.data.token;\n        const userData = {\n          id: response.data.user.id,\n          username: response.data.user.username\n        };\n        authService.login(userData, token);\n      }\n      return response.data;\n    } catch (error) {\n      console.error(\"Erreur lors de l'inscription:\", error);\n      throw error;\n    }\n  },\n  // Connexion\n  login: async credentials => {\n    try {\n      const response = await axios.post(`${API_URL}/users/login`, credentials);\n      console.log('Réponse du backend:', response.data);\n      // Vérifier que response.data est défini\n      if (response.data && response.data.token && response.data.userId) {\n        const token = response.data.token;\n        const userData = {\n          id: response.data.userId,\n          username: credentials.username\n        };\n        authService.login(userData, token);\n        if (token) {\n          // Appeler la méthode login du service d'authentification\n          authService.login(userData, token);\n        }\n      }\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la connexion:', error);\n      throw error;\n    }\n  },\n  // Déconnexion\n  logout: () => {\n    authService.logout();\n  },\n  // Récupérer le profil de l'utilisateur\n  getUserProfile: async () => {\n    try {\n      const response = await axios.get(`${API_URL}/users/profile`);\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la récupération du profil:', error);\n      throw error;\n    }\n  }\n};\n\n// Service pour les opérations liées aux farmers\nconst farmerService = {\n  // Recherche par localisation (ville)\n  searchByLocation: async (city, radius = 50) => {\n    try {\n      console.log(`Recherche des producteurs près de ${city} dans un rayon de ${radius}km`);\n      const response = await axios.get(`${API_URL}/farmers`, {\n        params: {\n          city,\n          radius\n        }\n      });\n      console.log('Résultats de la recherche:', response.data);\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la recherche par localisation:', error);\n      throw error;\n    }\n  },\n  // Recherche par coordonnées GPS\n  searchByCoordinates: async (latitude, longitude, radius = 50) => {\n    try {\n      console.log(`Recherche des producteurs aux coordonnées [${latitude}, ${longitude}] dans un rayon de ${radius}km`);\n      const response = await axios.get(`${API_URL}/farmers/coordinates`, {\n        params: {\n          latitude,\n          longitude,\n          radius\n        }\n      });\n      console.log('Résultats de la recherche par coordonnées:', response.data);\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la recherche par coordonnées:', error);\n      throw error;\n    }\n  },\n  // Récupérer les détails d'un producteur\n  getFarmer: async id => {\n    try {\n      const response = await axios.get(`${API_URL}/farmers/${id}`);\n      return response.data;\n    } catch (error) {\n      console.error(`Erreur lors de la récupération du producteur ${id}:`, error);\n      throw error;\n    }\n  },\n  // Créer un nouveau producteur\n  createFarmer: async farmerData => {\n    try {\n      console.log(\"Données avant envoi:\", Object.fromEntries(farmerData.entries()));\n      const response = await axios.post(`${API_URL}/farmers`, farmerData, {\n        headers: {\n          'Content-Type': 'multipart/form-data'\n        }\n      });\n      return response.data;\n    } catch (error) {\n      console.error(\"Erreur création farmer:\", error);\n      throw error;\n    }\n  },\n  // Mettre à jour un producteur\n  updateFarmer: async (id, formData) => {\n    try {\n      const response = await axios.put(`${API_URL}/farmers/${id}`, formData, {\n        headers: {\n          'Content-Type': 'multipart/form-data',\n          'Authorization': `Bearer ${authService.getToken()}`\n        }\n      });\n      return response.data;\n    } catch (error) {\n      console.error(\"Erreur mise à jour farmer:\", error);\n      throw error;\n    }\n  },\n  // Supprimer un producteur\n  deleteFarmer: async id => {\n    try {\n      await axios.delete(`${API_URL}/farmers/${id}`);\n      return true;\n    } catch (error) {\n      console.error(`Erreur lors de la suppression du producteur ${id}:`, error);\n      throw error;\n    }\n  }\n};\nexport { farmerService, userService };","map":{"version":3,"names":["axios","authService","API_URL","process","env","REACT_APP_API_URL","interceptors","request","use","config","token","sessionStorage","getItem","headers","error","Promise","reject","response","isAuthenticated","resetInactivityTimer","status","logout","userService","register","userData","post","data","id","user","username","login","console","credentials","log","userId","getUserProfile","get","farmerService","searchByLocation","city","radius","params","searchByCoordinates","latitude","longitude","getFarmer","createFarmer","farmerData","Object","fromEntries","entries","updateFarmer","formData","put","getToken","deleteFarmer","delete"],"sources":["/home/derfm53/save-agri/save-agri-frontend/src/services/api.js"],"sourcesContent":["// save-agri-frontend/src/services/api.js\nimport axios from 'axios';\nimport authService from './authService';\n\n// Configuration de l'URL de base pour les requêtes API\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001';\n\n// Configuration de l'intercepteur axios pour ajouter le token d'authentification\naxios.interceptors.request.use(\n  (config) => {\n    const token = sessionStorage.getItem('token');\n    if (token) {\n      config.headers['Authorization'] = `Bearer ${token}`;\n    }\n    return config;\n  },\n  (error) => {\n    return Promise.reject(error);\n  }\n);\n\n// Intercepteur pour gérer les réponses\naxios.interceptors.response.use(\n  (response) => {\n    // Réinitialiser le timer d'inactivité à chaque réponse réussie\n    if (authService.isAuthenticated()) {\n      authService.resetInactivityTimer();\n    }\n    return response;\n  },\n  (error) => {\n    // Si l'erreur est 401 (non autorisé), déconnexion\n    if (error.response && error.response.status === 401) {\n      authService.logout();\n    }\n    return Promise.reject(error);\n  }\n);\n\n// Service pour les opérations liées aux utilisateurs\nconst userService = {\n  // Inscription\n  register: async (userData) => {\n    try {\n      const response = await axios.post(`${API_URL}/users`, userData);  // Modification ici\n      if (response.data && response.data.token) {\n        const token = response.data.token;\n        const userData = {\n          id: response.data.user.id,\n          username: response.data.user.username\n        };\n        authService.login(userData, token);\n      }\n      return response.data;\n    } catch (error) {\n      console.error(\"Erreur lors de l'inscription:\", error);\n      throw error;\n    }\n  },\n\n  // Connexion\n  login: async (credentials) => {\n    try {\n      const response = await axios.post(`${API_URL}/users/login`, credentials);\n      console.log('Réponse du backend:', response.data);\n      // Vérifier que response.data est défini\n      if (response.data && response.data.token && response.data.userId) {\n        const token = response.data.token;\n        const userData = {\n          id: response.data.userId, \n        username: credentials.username\n      };\n      authService.login(userData, token);\n      if (token) {\n        // Appeler la méthode login du service d'authentification\n        authService.login(userData, token);\n      }\n    }\n    \n    return response.data;\n  } catch (error) {\n    console.error('Erreur lors de la connexion:', error);\n    throw error;\n  }\n},\n\n  // Déconnexion\n  logout: () => {\n    authService.logout();\n  },\n\n  // Récupérer le profil de l'utilisateur\n  getUserProfile: async () => {\n    try {\n      const response = await axios.get(`${API_URL}/users/profile`);\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la récupération du profil:', error);\n      throw error;\n    }\n  }\n};\n\n// Service pour les opérations liées aux farmers\nconst farmerService = {\n  // Recherche par localisation (ville)\n  searchByLocation: async (city, radius = 50) => {\n    try {\n      console.log(`Recherche des producteurs près de ${city} dans un rayon de ${radius}km`);\n      const response = await axios.get(`${API_URL}/farmers`, {\n        params: { city, radius }\n      });\n      console.log('Résultats de la recherche:', response.data);\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la recherche par localisation:', error);\n      throw error;\n    }\n  },\n\n  // Recherche par coordonnées GPS\n  searchByCoordinates: async (latitude, longitude, radius = 50) => {\n    try {\n      console.log(`Recherche des producteurs aux coordonnées [${latitude}, ${longitude}] dans un rayon de ${radius}km`);\n      const response = await axios.get(`${API_URL}/farmers/coordinates`, {\n        params: { latitude, longitude, radius }\n      });\n      console.log('Résultats de la recherche par coordonnées:', response.data);\n      return response.data;\n    } catch (error) {\n      console.error('Erreur lors de la recherche par coordonnées:', error);\n      throw error;\n    }\n  },\n\n  // Récupérer les détails d'un producteur\n  getFarmer: async (id) => {\n    try {\n      const response = await axios.get(`${API_URL}/farmers/${id}`);\n      return response.data;\n    } catch (error) {\n      console.error(`Erreur lors de la récupération du producteur ${id}:`, error);\n      throw error;\n    }\n  },  \n\n  // Créer un nouveau producteur\n  createFarmer: async (farmerData) => {\n    try {\n      console.log(\"Données avant envoi:\", Object.fromEntries(farmerData.entries()));\n      const response = await axios.post(`${API_URL}/farmers`, farmerData, {\n        headers: {\n          'Content-Type': 'multipart/form-data'\n        }\n      });\n      return response.data;\n    } catch (error) {\n      console.error(\"Erreur création farmer:\", error);\n      throw error;\n    }\n  },\n\n  // Mettre à jour un producteur\n  updateFarmer: async (id, formData) => {\n    try {\n      const response = await axios.put(`${API_URL}/farmers/${id}`, formData, {\n        headers: {\n          'Content-Type': 'multipart/form-data',\n          'Authorization': `Bearer ${authService.getToken()}`\n        }\n      });\n      return response.data;\n    } catch (error) {\n      console.error(\"Erreur mise à jour farmer:\", error);\n      throw error;\n    }\n  },\n\n  // Supprimer un producteur\n  deleteFarmer: async (id) => {\n    try {\n      await axios.delete(`${API_URL}/farmers/${id}`);\n      return true;\n    } catch (error) {\n      console.error(`Erreur lors de la suppression du producteur ${id}:`, error);\n      throw error;\n    }\n  }\n};\n\nexport { farmerService, userService };"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}